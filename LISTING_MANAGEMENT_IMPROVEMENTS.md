# 貼文管理功能改進說明

## 🎯 問題描述

之前的 admin 貼文管理頁面只能**查看**貼文，無法進行任何管理操作，這對於管理員來說功能不足。

## ✅ 改進內容

### 1. 新增 Admin 操作按鈕

每個貼文現在都有以下管理功能：

#### 📋 查看詳情
- 在新分頁開啟貼文詳細頁面
- 可以查看完整的貼文資訊和留言

#### 🚫 狀態管理
根據貼文當前狀態顯示不同操作：

**進行中的貼文 (Active):**
- **標記為取消** - 將貼文標記為已取消狀態
- **標記為過期** - 將貼文標記為過期狀態
- **刪除貼文** - 永久刪除（僅當無交易記錄時）

**已取消/過期的貼文:**
- **恢復為進行中** - 將貼文狀態恢復為 Active

**已完成的貼文 (Completed):**
- 無操作按鈕（已完成的交易不應被修改）

### 2. 改進的 UI 設計

#### 更豐富的資訊顯示
- ✅ 中文化的類型標籤（售票/收票/換票）
- ✅ 中文化的狀態標籤（進行中/已完成/已取消/已過期）
- ✅ 場地資訊 (📍)
- ✅ 發布者資訊 (👤)
- ✅ 發布時間 (📅)
- ✅ 交易數量 (💼)
- ✅ 貼文內容顯示在灰色背景框中

#### 視覺改進
- 卡片懸停效果 (hover:shadow-md)
- 更清晰的排版
- 操作按鈕統一放在右側
- 顏色編碼更明確（紅色=取消，灰色=過期，綠色=進行中，藍色=完成）

### 3. 後端 API 權限增強

#### PATCH /api/listings/[id]
**改進前:**
- 只允許貼文擁有者修改自己的貼文
- 只能使用 Active 或 Canceled 狀態

**改進後:**
- ✅ **擁有者** 可以修改自己的貼文
- ✅ **管理員 (Operator)** 可以修改任何貼文
- ✅ 管理員可使用所有狀態：Active, Canceled, Expired, Completed
- ✅ 管理員可以修改已完成的貼文（普通用戶不行）

#### DELETE /api/listings/[id]
**改進前:**
- 只允許貼文擁有者刪除自己的貼文

**改進後:**
- ✅ **擁有者** 可以刪除自己的貼文
- ✅ **管理員 (Operator)** 可以刪除任何貼文
- ✅ 保留安全檢查：有活躍交易的貼文無法刪除

### 4. 安全性考量

#### 刪除限制
只有在以下情況下才能刪除貼文：
- 沒有進行中或爭議中的交易
- 交易數為 0 或所有交易都已完成/取消

#### 權限檢查
- 每個操作都會驗證用戶是否為 Operator
- 使用 `session.roles.includes('Operator')` 檢查權限

### 5. 管理說明

在貼文管理頁面底部新增了詳細的管理說明：

```
管理說明
• 查看詳情: 在新分頁開啟貼文詳細頁面
• 標記為取消/過期: 將進行中的貼文標記為取消或過期狀態
• 恢復為進行中: 將已取消或過期的貼文恢復為進行中
• 刪除貼文: 永久刪除沒有交易記錄的貼文（已完成或有交易的貼文無法刪除）
• 建議：對於違規內容，先標記為取消，確認無問題後再刪除
```

## 🎨 使用案例

### 案例 1: 處理違規貼文
1. 管理員在貼文管理看到不當內容
2. 點擊「標記為取消」暫時下架
3. 點擊「查看詳情」確認內容
4. 如果確定違規，點擊「刪除貼文」永久移除

### 案例 2: 處理過期活動
1. 發現某個活動已經結束但貼文還在
2. 點擊「標記為過期」
3. 貼文狀態變為過期，不再顯示在活躍列表

### 案例 3: 誤操作恢復
1. 用戶投訴貼文被誤標記為取消
2. 管理員查看後確認是誤操作
3. 點擊「恢復為進行中」
4. 貼文恢復正常狀態

## 📊 功能對照表

| 功能 | 改進前 | 改進後 |
|------|--------|--------|
| 查看貼文列表 | ✅ | ✅ |
| 修改貼文狀態 | ❌ | ✅ |
| 刪除貼文 | ❌ | ✅ |
| 查看貼文詳情 | ❌ | ✅ |
| 中文化標籤 | ❌ | ✅ |
| 管理說明 | ❌ | ✅ |
| 權限控制 | ❌ | ✅ |
| 視覺改進 | 基本 | ✨ 豐富 |

## 🔐 權限矩陣

| 操作 | 普通用戶 (自己的貼文) | 管理員 (任何貼文) |
|------|---------------------|------------------|
| 查看 | ✅ | ✅ |
| 修改內容 | ✅ | ✅ |
| Active ↔ Canceled | ✅ | ✅ |
| Active → Expired | ❌ | ✅ |
| 修改 Completed | ❌ | ✅ |
| 刪除（無交易） | ✅ | ✅ |
| 刪除（有交易） | ❌ | ❌ |

## 💻 技術實現

### Frontend (admin/page.tsx)
```typescript
// 新增兩個處理函數
handleUpdateListingStatus(listingId, status) // 更新狀態
handleDeleteListing(listingId)              // 刪除貼文
```

### Backend (api/listings/[id]/route.ts)
```typescript
// 權限檢查
const isOwner = checkResult.rows[0].user_id === session.user_id;
const isOperator = session.roles.includes('Operator');

if (!isOwner && !isOperator) {
  // 拒絕訪問
}

// 狀態驗證
const allowedStatuses = isOperator 
  ? ['Active', 'Canceled', 'Expired', 'Completed']
  : ['Active', 'Canceled'];
```

## 🎉 總結

貼文管理功能從「只能看」變成「可以管」：
- ✅ 完整的 CRUD 操作
- ✅ 靈活的狀態管理
- ✅ 安全的權限控制
- ✅ 友好的用戶介面
- ✅ 清晰的操作說明

現在管理員可以有效地管理平台上的所有貼文，確保內容品質和平台秩序！ 🚀

