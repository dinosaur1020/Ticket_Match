# 新功能說明 - 加入票券與換票功能

## 🎫 功能一：加入票券

### 功能說明
使用者可以手動新增票券到自己的帳號中，方便管理和交易。

### 使用步驟
1. 登入系統後，前往「我的票券管理」頁面（Dashboard）
2. 點擊 **「➕ 新增票券」** 按鈕
3. 填寫票券資訊：
   - **選擇活動**：從下拉選單選擇活動
   - **選擇場次**：選擇該活動的具體場次時間
   - **座位區域**：輸入座位區域（例如：A區、VIP、搖滾區）
   - **座位號碼**：輸入座位號碼（例如：12排8號、01）
   - **票價**：輸入票券價格
4. 點擊「確認新增」完成

### API 端點
```
POST /api/tickets
```

**Request Body:**
```json
{
  "eventtime_id": 1,
  "seat_area": "A區",
  "seat_number": "12排8號",
  "price": 3500
}
```

**Response:**
```json
{
  "message": "Ticket created successfully",
  "ticket": {
    "ticket_id": 123,
    "eventtime_id": 1,
    "owner_id": 5,
    "seat_area": "A區",
    "seat_number": "12排8號",
    "price": 3500,
    "status": "Active",
    "event_name": "五月天演唱會",
    "venue": "台北小巨蛋",
    "start_time": "2025-12-25T19:00:00"
  }
}
```

### 注意事項
- 同一場次的同一座位只能新增一次
- 新增的票券狀態自動為 `Active`
- 可以在「我的票券」頁面查看所有票券

---

## 🔄 功能二：換票功能

### 功能說明
使用者可以發起換票貼文，與其他使用者交換票券。支援等價交換或補差價交換。

### 使用場景
- **等價交換**：想換不同場次或不同座位的票
- **補差價交換**：願意補差價換更好的座位

### 使用步驟

#### A. 發起換票貼文
1. 前往「活動列表」或「貼文列表」
2. 點擊「➕ 新增貼文」（需要業務經營者權限或在活動詳情頁）
3. 選擇貼文類型：**「Exchange（換票）」**
4. 填寫貼文內容，**務必說明**：
   - 您擁有的票券（票券ID、座位、場次等）
   - 您想要換的票券條件
   - 是否願意補差價
5. 發布貼文

**貼文內容範例：**
```
我有 12/25 A區 5排6號的票（票券ID: 123），
想換 12/30 同場次的票，任何區域都可以。
如果是更好的座位，願意補差價 500 元。
```

#### B. 回應換票貼文
1. 瀏覽「貼文列表」，找到 **「換票」** 類型的貼文
2. 點擊進入貼文詳情頁
3. 填寫交易資訊：
   - **協議金額**：
     - 輸入 `0` 表示等價交換
     - 輸入金額表示您願意支付的差價
   - **選擇您要提供的票券**：從您的票券列表中勾選
   - **選擇您想換取的票券**：輸入對方在貼文中提到的票券ID（用逗號分隔，例如：123,124）
4. 點擊「確認發起交易」

#### C. 確認交易
1. 前往「我的交易」頁面
2. 雙方都需要點擊「確認交易」
3. 當雙方都確認後：
   - 票券自動轉移所有權
   - 如有差價，餘額自動扣除/增加
   - 交易狀態變更為 `Completed`

### 交易流程圖
```
用戶A發起換票貼文（含票券123）
           ↓
用戶B看到貼文，決定交換（提供票券456）
           ↓
用戶B發起交易（選擇自己的票券456，對方的票券123）
           ↓
系統建立交易（狀態：Pending）
           ↓
雙方確認交易
           ↓
系統執行：
  - 票券123：A → B
  - 票券456：B → A
  - 差價支付（如有）
           ↓
交易完成（狀態：Completed）
```

### API 更新

#### 創建交易 (支援 Exchange)
```
POST /api/trades
```

**Request Body (Exchange 類型):**
```json
{
  "listing_id": 10,
  "agreed_price": 500,
  "ticket_ids": [456],
  "listing_owner_ticket_ids": [123]
}
```

- `agreed_price`: 差價金額（0表示等價交換）
- `ticket_ids`: 交易發起者提供的票券ID陣列
- `listing_owner_ticket_ids`: 貼文擁有者提供的票券ID陣列

#### 確認交易 (自動處理 Exchange)
```
POST /api/trades/{id}/confirm
```

系統會自動處理：
- Exchange with price = 0：純票券交換，無餘額變動
- Exchange with price > 0：票券交換 + 差價支付

### 併行控制
系統使用樂觀鎖定機制，確保：
- 同一張票不會被多次交易
- 防止雙重消費
- 保證資料一致性

當票券被鎖定時：
```sql
UPDATE ticket
SET status = 'Locked'
WHERE ticket_id = ? AND owner_id = ? AND status = 'Active'
```

如果更新失敗（rowCount = 0），表示票券已被其他交易鎖定。

---

## 📊 資料庫變更

### Trade Participant 角色擴充
新增 `exchanger` 角色：

```sql
-- 原有角色
'buyer', 'seller'

-- 新增角色（用於換票）
'exchanger'
```

### Exchange 交易的參與者
```sql
-- 雙方都是 exchanger
INSERT INTO trade_participant (trade_id, user_id, role)
VALUES 
  (1, 10, 'exchanger'),  -- 貼文擁有者
  (1, 20, 'exchanger');  -- 交易發起者
```

### 票券流動記錄
```sql
-- TRADE_TICKET 記錄雙向票券轉移
INSERT INTO trade_ticket (trade_id, ticket_id, from_user_id, to_user_id)
VALUES 
  (1, 123, 10, 20),  -- 票券123：用戶10 → 用戶20
  (1, 456, 20, 10);  -- 票券456：用戶20 → 用戶10
```

---

## 🎨 前端更新

### 新增頁面
- `/tickets/add` - 新增票券頁面

### 更新頁面
- `/dashboard` - 新增「新增票券」按鈕
- `/listings/[id]` - 支援 Exchange 類型的交易發起

### UI 改進
- Exchange 貼文顯示橘色標籤
- 換票頁面提供詳細說明與提示
- 自動檢查餘額是否足夠支付差價

---

## ✅ 測試建議

### 測試案例 1：新增票券
1. 登入系統
2. 前往 Dashboard → 新增票券
3. 選擇活動與場次
4. 填寫座位資訊
5. 確認票券出現在「我的票券」列表

### 測試案例 2：等價換票
1. 用戶A：發起換票貼文（說明票券123）
2. 用戶B：回應貼文，選擇自己的票券456，輸入對方的票券123
3. 協議金額設為 0
4. 雙方確認交易
5. 驗證票券所有權已交換

### 測試案例 3：補差價換票
1. 用戶A：發起換票貼文
2. 用戶B：回應貼文，協議金額設為 500
3. 雙方確認交易
4. 驗證：
   - 票券已交換
   - 用戶A餘額 +500
   - 用戶B餘額 -500
   - USER_BALANCE_LOG 有記錄

### 測試案例 4：併行控制
1. 用戶B和用戶C同時嘗試換用戶A的同一張票
2. 第一個確認的交易成功
3. 第二個交易收到「票券已被鎖定」錯誤

---

## 🔒 安全性考量

1. **票券驗證**：確認票券屬於正確的用戶
2. **狀態檢查**：只能交易 `Active` 狀態的票券
3. **餘額檢查**：確保支付方有足夠餘額
4. **原子性**：使用資料庫交易確保 ACID 特性
5. **防止自我交易**：不能與自己的貼文交易

---

## 📝 注意事項

1. **票券ID的溝通**：
   - Exchange 交易需要雙方溝通票券ID
   - 建議在貼文內容中明確說明票券資訊
   - 未來可考慮新增「我的票券分享」功能

2. **差價計算**：
   - 正數表示發起者支付給擁有者
   - 差價為0表示等價交換
   - 系統會自動檢查餘額是否足夠

3. **交易確認**：
   - 需要雙方都確認才會執行
   - 確認後無法撤銷
   - 建議仔細檢查再確認

---

## 🚀 未來改進方向

1. **票券展示優化**：
   - 在 Exchange 貼文中自動顯示擁有者的票券
   - 提供票券預覽功能

2. **智能配對**：
   - 根據用戶偏好推薦可交換的票券
   - 自動計算合理的差價

3. **聊天功能**：
   - 讓交易雙方可以即時溝通
   - 協商交易細節

4. **評價系統**：
   - 交易完成後可以互相評價
   - 建立信用體系

---

完成時間：2025-12-03
實作者：AI Assistant

