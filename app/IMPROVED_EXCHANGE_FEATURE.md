# æ”¹é€²å¾Œçš„æ›ç¥¨åŠŸèƒ½èªªæ˜

## ğŸ”„ åŠŸèƒ½æ”¹é€²

### å•é¡Œ
ä¹‹å‰çš„æ›ç¥¨åŠŸèƒ½è¦æ±‚ç”¨æˆ¶æ‰‹å‹•è¼¸å…¥å°æ–¹çš„ç¥¨åˆ¸IDï¼Œé€™æ¨£çš„é«”é©—å¾ˆå·®ï¼š
- âŒ ç”¨æˆ¶éœ€è¦å¾è²¼æ–‡å…§å®¹ä¸­æ‰‹å‹•æŸ¥æ‰¾ç¥¨åˆ¸ID
- âŒ å®¹æ˜“è¼¸å…¥éŒ¯èª¤
- âŒ ä¸ç›´è§€

### è§£æ±ºæ–¹æ¡ˆ
æ”¹ç”¨è³‡æ–™åº«æ¬„ä½ä¾†å­˜å„²æä¾›çš„ç¥¨åˆ¸ï¼Œè‡ªå‹•é¡¯ç¤ºï¼š
- âœ… ç™¼èµ·æ›ç¥¨æ™‚ç›´æ¥é¸æ“‡ç¥¨åˆ¸
- âœ… å›æ‡‰æ›ç¥¨æ™‚è‡ªå‹•é¡¯ç¤ºå°æ–¹çš„ç¥¨åˆ¸
- âœ… è¦–è¦ºåŒ–ã€ç›´è§€ã€ä¸æ˜“å‡ºéŒ¯

---

## ğŸ“Š è³‡æ–™åº«è®Šæ›´

### æ–°å¢æ¬„ä½
åœ¨ `LISTING` è¡¨ä¸­æ·»åŠ ä¸€å€‹æ¬„ä½ï¼š

```sql
ALTER TABLE LISTING ADD COLUMN offered_ticket_ids INTEGER[] DEFAULT NULL;
```

- ä½¿ç”¨ PostgreSQL çš„æ•¸çµ„é¡å‹
- å­˜å„²å¤šå€‹ç¥¨åˆ¸ID
- æ”¯æ´ Sell å’Œ Exchange é¡å‹çš„è²¼æ–‡

### åŸ·è¡Œ Migration

```bash
# åŸ·è¡Œ SQL è…³æœ¬
psql -d ticket_match -f app/scripts/add-offered-tickets-column.sql
```

æˆ–æ‰‹å‹•åŸ·è¡Œï¼š
```sql
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'listing' 
        AND column_name = 'offered_ticket_ids'
    ) THEN
        ALTER TABLE LISTING ADD COLUMN offered_ticket_ids INTEGER[] DEFAULT NULL;
    END IF;
END $$;

CREATE INDEX IF NOT EXISTS idx_listing_offered_tickets ON LISTING USING GIN (offered_ticket_ids);
```

---

## ğŸ¨ åŠŸèƒ½æµç¨‹

### A. å‰µå»ºæ›ç¥¨è²¼æ–‡

1. **å‰å¾€å‰µå»ºè²¼æ–‡é é¢**
   - Dashboard â†’ ã€ŒğŸ“ å»ºç«‹è²¼æ–‡ã€
   - æˆ– Listings â†’ ã€Œâ• å»ºç«‹è²¼æ–‡ã€

2. **é¸æ“‡è²¼æ–‡é¡å‹**ï¼šExchangeï¼ˆæ›ç¥¨ï¼‰

3. **å¡«å¯«è³‡è¨Š**ï¼š
   - é¸æ“‡æ´»å‹•
   - é¸æ“‡å ´æ¬¡
   - **é¸æ“‡è¦æä¾›çš„ç¥¨åˆ¸**ï¼ˆå¯å¤šé¸ï¼‰
   - å¡«å¯«è²¼æ–‡å…§å®¹ï¼ˆèªªæ˜äº¤æ›æ¢ä»¶ï¼‰

4. **ç™¼å¸ƒè²¼æ–‡**
   - ç³»çµ±å°‡ç¥¨åˆ¸IDå­˜å„²åœ¨ `offered_ticket_ids` æ¬„ä½
   - è²¼æ–‡ç‹€æ…‹ç‚º `Active`

**ç¯„ä¾‹**ï¼š
```
æ´»å‹•ï¼šäº”æœˆå¤©æ¼”å”±æœƒ
å ´æ¬¡ï¼š2025-12-25 19:00
æä¾›çš„ç¥¨åˆ¸ï¼š
  - Aå€ 5æ’6è™Ÿ ($3500)
  - Aå€ 5æ’7è™Ÿ ($3500)
è²¼æ–‡å…§å®¹ï¼šæƒ³æ› 12/30 çš„ç¥¨ï¼Œä»»ä½•å€åŸŸéƒ½å¯ä»¥ã€‚é¡˜æ„è£œå·®åƒ¹ã€‚
```

---

### B. å›æ‡‰æ›ç¥¨è²¼æ–‡

1. **ç€è¦½è²¼æ–‡åˆ—è¡¨**
   - æ‰¾åˆ°æ„Ÿèˆˆè¶£çš„æ›ç¥¨è²¼æ–‡ï¼ˆæ©˜è‰²ã€Œæ›ç¥¨ã€æ¨™ç±¤ï¼‰

2. **æŸ¥çœ‹è²¼æ–‡è©³æƒ…**
   - ç³»çµ±è‡ªå‹•é¡¯ç¤ºå°æ–¹æä¾›çš„ç¥¨åˆ¸
   - æ¸…æ¥šçœ‹åˆ°åº§ä½ã€åƒ¹æ ¼ã€å ´æ¬¡ç­‰è³‡è¨Š

3. **ç™¼èµ·äº¤æ˜“**
   - å¡«å¯«å”è­°é‡‘é¡ï¼ˆ0 = ç­‰åƒ¹äº¤æ›ï¼Œ>0 = è£œå·®åƒ¹ï¼‰
   - **é¸æ“‡æ‚¨è¦æä¾›çš„ç¥¨åˆ¸**ï¼ˆå¾ä¸‹æ‹‰é¸å–®å‹¾é¸ï¼‰
   - ~~ä¸å†éœ€è¦æ‰‹å‹•è¼¸å…¥å°æ–¹çš„ç¥¨åˆ¸ID~~

4. **ç¢ºèªäº¤æ˜“**
   - é›™æ–¹éƒ½éœ€è¦ç¢ºèª
   - ç³»çµ±è‡ªå‹•å®Œæˆç¥¨åˆ¸äº¤æ›å’Œå·®åƒ¹æ”¯ä»˜

---

## ğŸ”§ API æ›´æ–°

### 1. POST /api/listings - å‰µå»ºè²¼æ–‡

**Request Body**:
```json
{
  "event_id": 1,
  "event_date": "2025-12-25T19:00:00",
  "content": "æƒ³æ› 12/30 çš„ç¥¨ï¼Œé¡˜æ„è£œå·®åƒ¹",
  "type": "Exchange",
  "offered_ticket_ids": [123, 124]
}
```

**Response**:
```json
{
  "message": "Listing created successfully",
  "listing": {
    "listing_id": 10,
    "user_id": 5,
    "event_id": 1,
    "type": "Exchange",
    "offered_ticket_ids": [123, 124],
    "status": "Active"
  }
}
```

**é©—è­‰**ï¼š
- Exchange å’Œ Sell é¡å‹å¿…é ˆæä¾› `offered_ticket_ids`
- é©—è­‰ç¥¨åˆ¸å±¬æ–¼ç™¼èµ·è€…
- é©—è­‰ç¥¨åˆ¸ç‹€æ…‹ç‚º `Active`

---

### 2. GET /api/listings/[id] - ç²å–è²¼æ–‡è©³æƒ…

**Response**:
```json
{
  "listing": {
    "listing_id": 10,
    "user_id": 5,
    "username": "Alice",
    "event_id": 1,
    "event_name": "äº”æœˆå¤©æ¼”å”±æœƒ",
    "type": "Exchange",
    "offered_ticket_ids": [123, 124],
    "offered_tickets": [
      {
        "ticket_id": 123,
        "seat_area": "Aå€",
        "seat_number": "5æ’6è™Ÿ",
        "price": 3500,
        "event_name": "äº”æœˆå¤©æ¼”å”±æœƒ",
        "start_time": "2025-12-25T19:00:00",
        "status": "Active"
      },
      {
        "ticket_id": 124,
        "seat_area": "Aå€",
        "seat_number": "5æ’7è™Ÿ",
        "price": 3500,
        "event_name": "äº”æœˆå¤©æ¼”å”±æœƒ",
        "start_time": "2025-12-25T19:00:00",
        "status": "Active"
      }
    ]
  }
}
```

**è®Šæ›´**ï¼š
- è‡ªå‹• JOIN ticket è¡¨ç²å–ç¥¨åˆ¸è©³æƒ…
- è¿”å›å®Œæ•´çš„ç¥¨åˆ¸è³‡è¨Šï¼ˆä¸åªæ˜¯IDï¼‰

---

### 3. POST /api/trades - å‰µå»ºäº¤æ˜“

**Request Body (Exchange)**:
```json
{
  "listing_id": 10,
  "agreed_price": 500,
  "ticket_ids": [456, 457],
  "listing_owner_ticket_ids": [123, 124]
}
```

**èªªæ˜**ï¼š
- `ticket_ids`: äº¤æ˜“ç™¼èµ·è€…æä¾›çš„ç¥¨åˆ¸
- `listing_owner_ticket_ids`: å¾ listing.offered_ticket_ids è‡ªå‹•ç²å–ï¼ˆå‰ç«¯å‚³å…¥ï¼‰
- `agreed_price`: å·®åƒ¹é‡‘é¡

---

## ğŸ–¥ï¸ å‰ç«¯æ›´æ–°

### æ–°å¢é é¢

#### 1. `/listings/create` - å‰µå»ºè²¼æ–‡é é¢

**åŠŸèƒ½**ï¼š
- é¸æ“‡è²¼æ–‡é¡å‹ï¼ˆSell / Buy / Exchangeï¼‰
- å‹•æ…‹è¡¨å–®ï¼ˆæ ¹æ“šé¡å‹é¡¯ç¤ºä¸åŒæ¬„ä½ï¼‰
- Exchange å’Œ Sell é¡å‹éœ€è¦é¸æ“‡ç¥¨åˆ¸
- ç¥¨åˆ¸é¸æ“‡å™¨ï¼ˆcheckbox å¤šé¸ï¼‰
- å¯¦æ™‚é¡¯ç¤ºå·²é¸æ“‡çš„ç¥¨åˆ¸æ•¸é‡

**UI ç‰¹è‰²**ï¼š
- ä¸‰ç¨®é¡å‹ç”¨ä¸åŒé¡è‰²å€åˆ†
- è‡ªå‹•éæ¿¾ç›¸é—œæ´»å‹•çš„ç¥¨åˆ¸
- æ²’æœ‰ç¥¨åˆ¸æ™‚æä¾›ã€Œæ–°å¢ç¥¨åˆ¸ã€å¿«æ·å…¥å£

---

### æ›´æ–°é é¢

#### 2. `/listings/[id]` - è²¼æ–‡è©³æƒ…é 

**Exchange è²¼æ–‡çš„æ”¹é€²**ï¼š

**Before**:
```tsx
// ç”¨æˆ¶éœ€è¦æ‰‹å‹•è¼¸å…¥ç¥¨åˆ¸ID ğŸ˜
<input 
  placeholder="è¼¸å…¥ç¥¨åˆ¸IDï¼Œå¤šå¼µç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼š1,2,3"
  onChange={...}
/>
```

**After**:
```tsx
// è‡ªå‹•é¡¯ç¤ºå°æ–¹çš„ç¥¨åˆ¸ ğŸ˜Š
{listing.offered_tickets.map(ticket => (
  <div className="border border-blue-300 bg-blue-50 rounded-lg p-3">
    <p className="font-semibold">{ticket.event_name}</p>
    <p>{ticket.seat_area} {ticket.seat_number} - ${ticket.price}</p>
    <span className="text-green-600">âœ“</span>
  </div>
))}
```

**è®Šæ›´**ï¼š
- âœ… ç§»é™¤æ‰‹å‹•è¼¸å…¥ç¥¨åˆ¸IDçš„æ¬„ä½
- âœ… è‡ªå‹•é¡¯ç¤º `listing.offered_tickets`
- âœ… è¦–è¦ºåŒ–é¡¯ç¤ºç¥¨åˆ¸è³‡è¨Š
- âœ… å‰ç«¯è‡ªå‹•ä½¿ç”¨ `listing.offered_ticket_ids`

---

#### 3. `/dashboard` - Dashboard

**æ–°å¢æŒ‰éˆ•**ï¼š
- â• æ–°å¢ç¥¨åˆ¸
- ğŸ“ å»ºç«‹è²¼æ–‡ï¼ˆæ–°å¢ï¼‰
- ğŸ” ç€è¦½è²¼æ–‡

---

#### 4. `/listings` - è²¼æ–‡åˆ—è¡¨

**æ–°å¢æŒ‰éˆ•**ï¼š
- å³ä¸Šè§’ã€Œâ• å»ºç«‹è²¼æ–‡ã€æŒ‰éˆ•

---

## ğŸ“ TypeScript å‹åˆ¥æ›´æ–°

```typescript
// lib/types.ts

export interface Listing {
  listing_id: number;
  user_id: number;
  event_id: number;
  event_date: Date;
  content?: string;
  status: 'Active' | 'Canceled' | 'Completed' | 'Expired';
  type: 'Sell' | 'Buy' | 'Exchange';
  offered_ticket_ids?: number[];  // æ–°å¢
  created_at: Date;
}

export interface ListingWithEvent extends Listing {
  event_name: string;
  venue: string;
  username: string;
  offered_tickets?: TicketWithEvent[];  // æ–°å¢
}
```

---

## âœ… ä½¿ç”¨æµç¨‹å°æ¯”

### Beforeï¼ˆèˆŠç‰ˆï¼‰

```
ç”¨æˆ¶Aå‰µå»ºæ›ç¥¨è²¼æ–‡
  â†“
ç”¨æˆ¶Aåœ¨å…§å®¹ä¸­å¯«ï¼š"æˆ‘æœ‰ç¥¨åˆ¸ID: 123, 124"
  â†“
ç”¨æˆ¶Bçœ‹åˆ°è²¼æ–‡
  â†“
ç”¨æˆ¶Béœ€è¦å¾å…§å®¹ä¸­æ‰¾åˆ° "123, 124"
  â†“
ç”¨æˆ¶Bæ‰‹å‹•è¼¸å…¥ "123,124"  âŒ å®¹æ˜“å‡ºéŒ¯
  â†“
ç™¼èµ·äº¤æ˜“
```

### Afterï¼ˆæ–°ç‰ˆï¼‰

```
ç”¨æˆ¶Aå‰µå»ºæ›ç¥¨è²¼æ–‡
  â†“
ç”¨æˆ¶Aåœ¨è¡¨å–®ä¸­å‹¾é¸ç¥¨åˆ¸ âœ“ ç›´è§€
  â†“
ç³»çµ±è‡ªå‹•å­˜å„²åˆ° offered_ticket_ids
  â†“
ç”¨æˆ¶Bçœ‹åˆ°è²¼æ–‡
  â†“
ç³»çµ±è‡ªå‹•é¡¯ç¤ºå°æ–¹çš„ç¥¨åˆ¸ï¼ˆå®Œæ•´è³‡è¨Šï¼‰ âœ“ æ¸…æ¥š
  â†“
ç”¨æˆ¶Båªéœ€é¸æ“‡è‡ªå·±çš„ç¥¨åˆ¸ âœ“ ç°¡å–®
  â†“
ç™¼èµ·äº¤æ˜“
```

---

## ğŸ¯ è³‡æ–™åº«æ¸¬è©¦è³‡æ–™

### ç¾æœ‰ Exchange Listing

| ID | ç”¨æˆ¶ | æ´»å‹• | æä¾›çš„ç¥¨åˆ¸ | èªªæ˜ |
|----|------|------|------------|------|
| 3  | Alice | å‘¨æ°å€«æ¼”å”±æœƒ | {5} | Aå€1å¼µ |
| 17 | Frank | å‘¨æ°å€«æ¼”å”±æœƒ | {16} | VIPå€1å¼µ |
| 24 | Alice | äº”æœˆå¤©æ¼”å”±æœƒ | {1,2} | Aå€é€£è™Ÿ2å¼µ |
| 25 | Bob | å‘Šäº”äººæ¼”å”±æœƒ | {17} | VIPç¥¨1å¼µ |
| 26 | Frank | äº”æœˆå¤©æ¼”å”±æœƒ | {15} | VIPå€1å¼µ |
| 27 | David | å‘¨æ°å€«æ¼”å”±æœƒ | {13} | VIPå€1å¼µ |
| 28 | Charlie | æ—ä¿Šå‚‘æ¼”å”±æœƒ | {21} | VIPç¥¨1å¼µ |

### æ¸¬è©¦å ´æ™¯

1. **Alice (ID: 24)** æä¾›äº”æœˆå¤©Aå€é€£è™Ÿ2å¼µï¼Œæƒ³æ›12/27 VIPç¥¨
2. **Bob (ID: 25)** æä¾›å‘Šäº”äººVIPç¥¨ï¼Œæƒ³æ›äº”æœˆå¤©ä»»ä¸€å ´
3. **Frank (ID: 26)** æä¾›äº”æœˆå¤©VIPç¥¨ï¼Œæƒ³æ›å‘¨æ°å€«VIPç¥¨
4. **David (ID: 27)** æä¾›å‘¨æ°å€«VIPç¥¨ï¼Œæƒ³æ›å‘Šäº”äººVIPç¥¨
5. **Charlie (ID: 28)** æä¾›æ—ä¿Šå‚‘VIPç¥¨ï¼Œæ›ç”°é¦¥ç”„ç¥¨

---

## ğŸ§ª æ¸¬è©¦å ´æ™¯

### æ¸¬è©¦ 1ï¼šå‰µå»º Exchange è²¼æ–‡

1. ç™»å…¥ç³»çµ±ï¼ˆä¾‹å¦‚ç”¨æˆ¶ Aliceï¼‰
2. å‰å¾€ Dashboard â†’ ã€ŒğŸ“ å»ºç«‹è²¼æ–‡ã€
3. é¸æ“‡ Exchange é¡å‹
4. é¸æ“‡æ´»å‹•å’Œå ´æ¬¡
5. å‹¾é¸è¦æä¾›çš„ç¥¨åˆ¸ï¼ˆè‡³å°‘ä¸€å¼µï¼‰
6. å¡«å¯«å…§å®¹èªªæ˜äº¤æ›æ¢ä»¶
7. æäº¤
8. âœ… é©—è­‰è²¼æ–‡æˆåŠŸå‰µå»º
9. âœ… é©—è­‰ offered_ticket_ids æœ‰å€¼

### æ¸¬è©¦ 2ï¼šå›æ‡‰ Exchange è²¼æ–‡

1. ç™»å…¥å¦ä¸€å€‹ç”¨æˆ¶ï¼ˆä¾‹å¦‚ Bobï¼‰
2. ç€è¦½è²¼æ–‡åˆ—è¡¨ï¼Œæ‰¾åˆ° Alice çš„æ›ç¥¨è²¼æ–‡
3. é»æ“Šé€²å…¥è©³æƒ…é 
4. âœ… é©—è­‰å¯ä»¥çœ‹åˆ° Alice æä¾›çš„ç¥¨åˆ¸ï¼ˆè‡ªå‹•é¡¯ç¤ºï¼‰
5. é¸æ“‡è‡ªå·±çš„ç¥¨åˆ¸
6. è¼¸å…¥å”è­°é‡‘é¡ï¼ˆä¾‹å¦‚ 500ï¼‰
7. ç™¼èµ·äº¤æ˜“
8. âœ… é©—è­‰äº¤æ˜“æˆåŠŸå‰µå»º

### æ¸¬è©¦ 3ï¼šå®Œæˆ Exchange äº¤æ˜“

1. Alice å’Œ Bob éƒ½é€²å…¥ã€Œæˆ‘çš„äº¤æ˜“ã€
2. é›™æ–¹åˆ†åˆ¥é»æ“Šã€Œç¢ºèªäº¤æ˜“ã€
3. âœ… é©—è­‰ç¥¨åˆ¸æ‰€æœ‰æ¬Šå·²äº¤æ›
   - ç¥¨åˆ¸123, 124: Alice â†’ Bob
   - ç¥¨åˆ¸456, 457: Bob â†’ Alice
4. âœ… é©—è­‰å·®åƒ¹å·²æ”¯ä»˜
   - Alice é¤˜é¡ +500
   - Bob é¤˜é¡ -500

---

## ğŸ“‚ ä¿®æ”¹çš„æª”æ¡ˆåˆ—è¡¨

### æ–°å¢æª”æ¡ˆ
1. `app/scripts/add-offered-tickets-column.sql` - Migration è…³æœ¬
2. `app/app/listings/create/page.tsx` - å‰µå»ºè²¼æ–‡é é¢
3. `app/IMPROVED_EXCHANGE_FEATURE.md` - æœ¬æ–‡ä»¶

### ä¿®æ”¹æª”æ¡ˆ
1. `app/lib/types.ts` - æ·»åŠ  offered_ticket_ids å’Œ offered_tickets
2. `app/app/api/listings/route.ts` - POST æ”¯æ´ offered_ticket_ids
3. `app/app/api/listings/[id]/route.ts` - GET è¿”å› offered_tickets
4. `app/app/listings/[id]/page.tsx` - ç°¡åŒ– Exchange UI
5. `app/app/listings/page.tsx` - æ·»åŠ å‰µå»ºè²¼æ–‡æŒ‰éˆ•
6. `app/app/dashboard/page.tsx` - æ·»åŠ å‰µå»ºè²¼æ–‡æŒ‰éˆ•

---

## ğŸ¯ æ”¹é€²ç¸½çµ

| é …ç›® | èˆŠç‰ˆ | æ–°ç‰ˆ |
|------|------|------|
| ç¥¨åˆ¸é¸æ“‡ | æ‰‹å‹•è¼¸å…¥ID | è¦–è¦ºåŒ–å‹¾é¸ âœ“ |
| ç¥¨åˆ¸é¡¯ç¤º | éœ€å¾å…§å®¹è§£æ | è‡ªå‹•é¡¯ç¤ºå®Œæ•´è³‡è¨Š âœ“ |
| ç”¨æˆ¶é«”é©— | è¤‡é›œã€æ˜“éŒ¯ | ç°¡å–®ã€ç›´è§€ âœ“ |
| è³‡æ–™å­˜å„² | åƒ…åœ¨å…§å®¹ä¸­ | è³‡æ–™åº«æ¬„ä½ âœ“ |
| ç¶­è­·æ€§ | ä½ | é«˜ âœ“ |

---

## ğŸš€ æœªä¾†å¯èƒ½çš„æ”¹é€²

1. **æ™ºèƒ½æ¨è–¦**ï¼šæ ¹æ“šç”¨æˆ¶çš„ç¥¨åˆ¸å’Œåå¥½æ¨è–¦å¯äº¤æ›çš„è²¼æ–‡
2. **æ‰¹é‡æ“ä½œ**ï¼šä¸€æ¬¡å‰µå»ºå¤šå€‹æ›ç¥¨è²¼æ–‡
3. **æ”¶è—å¤¾**ï¼šæ”¶è—æ„Ÿèˆˆè¶£çš„è²¼æ–‡
4. **é€šçŸ¥ç³»çµ±**ï¼šæœ‰äººå›æ‡‰è²¼æ–‡æ™‚é€šçŸ¥
5. **è©•åƒ¹ç³»çµ±**ï¼šäº¤æ˜“å®Œæˆå¾Œäº’ç›¸è©•åƒ¹

---

å®Œæˆæ™‚é–“ï¼š2025-12-03
å¯¦ä½œè€…ï¼šAI Assistant

